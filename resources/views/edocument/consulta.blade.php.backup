<x-app-layout>
    @vite(['resources/css/mve-create.css', 'resources/js/edocument-consulta.js'])

    <div class="min-h-screen bg-[#F8FAFC]">
        <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-20">
                    <div class="flex items-center gap-4">
                        <a href="{{ route('dashboard') }}">
                            <img src="{{ asset('logo-ei.png') }}" alt="Logo E&I" class="h-10 w-auto">
                        </a>
                        <div class="hidden md:block h-8 w-px bg-slate-200"></div>
                        <span class="hidden md:block text-sm font-bold text-[#001a4d] uppercase tracking-wider">
                            Consulta eDocument (VUCEM)
                        </span>
                    </div>

                    <div class="flex items-center gap-6">
                        <div class="text-right hidden sm:block">
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Usuario Conectado</p>
                            <p class="text-sm font-black text-[#003399]">{{ auth()->user()->full_name }}</p>
                        </div>

                        <div class="user-dropdown">
                            <div id="avatarButton" class="avatar-button h-10 w-10 bg-ei-gradient rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                                {{ substr(auth()->user()->full_name, 0, 1) }}
                            </div>

                            <div id="dropdownMenu" class="dropdown-menu">
                                <div class="dropdown-header">
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Mi Cuenta</p>
                                    <p class="text-sm font-bold text-[#001a4d] mt-1">{{ auth()->user()->full_name }}</p>
                                    <p class="text-xs text-slate-500 mt-0.5">{{ auth()->user()->email }}</p>
                                </div>

                                <a href="{{ route('profile.edit') }}" class="dropdown-item">
                                    <i data-lucide="user-circle" class="w-5 h-5"></i>
                                    <span class="font-semibold text-sm">Mi Perfil</span>
                                </a>

                                <form method="POST" action="{{ route('logout') }}" id="logoutForm">
                                    @csrf
                                    <button type="submit" class="dropdown-item logout w-full">
                                        <i data-lucide="log-out" class="w-5 h-5"></i>
                                        <span class="font-semibold text-sm">Cerrar Sesi√≥n</span>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="max-w-5xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
            <div class="mb-10">
                <a href="{{ route('dashboard') }}" class="inline-flex items-center text-sm font-semibold text-slate-600 hover:text-[#003399] transition-colors mb-6">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Regresar al Dashboard
                </a>

                <h2 class="text-4xl font-black text-[#001a4d] tracking-tight">
                    Consulta <span class="text-[#003399]">eDocument</span> en VUCEM
                </h2>
                <p class="text-slate-500 mt-2">
                    Ingresa el folio del eDocument para consultar en VUCEM. Las credenciales (RFC y clave webservice) se obtienen autom√°ticamente de su perfil de usuario.
                </p>
                
                <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                        <i data-lucide="info" class="w-4 h-4 mr-2"></i>
                        Informaci√≥n sobre Credenciales VUCEM
                    </h3>
                    <div class="text-xs text-blue-700 space-y-1">
                        <p>‚Ä¢ <strong>RFC:</strong> Se obtiene autom√°ticamente de su perfil o de los RFC asociados a su cuenta</p>
                        <p>‚Ä¢ <strong>Clave WebService:</strong> Se obtiene autom√°ticamente de su configuraci√≥n VUCEM</p>
                        <p>‚Ä¢ <strong>eFirma:</strong> Se usa la configuraci√≥n global del sistema para la firma electr√≥nica</p>
                        <p>‚Ä¢ <strong>Sin archivos:</strong> No es necesario subir certificados o llaves privadas</p>
                    </div>
                </div>
            </div>

            @if ($errors->any())
                <div class="mb-6 rounded-lg border border-red-200 bg-red-50 p-4">
                    <div class="flex items-start">
                        <div class="flex-shrink-0">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500 mt-0.5"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-semibold text-red-800 mb-2">Error de Validaci√≥n</h3>
                            <ul class="list-disc list-inside space-y-1 text-sm text-red-700">
                                @foreach ($errors->all() as $error)
                                    <li>{{ $error }}</li>
                                @endforeach
                            </ul>
                            
                            @if ($errors->has('certificado') && str_contains($errors->first('certificado'), 'X.509'))
                                <div class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
                                    <h4 class="text-sm font-medium text-yellow-800 mb-1">üí° Ayuda para Certificados</h4>
                                    <p class="text-xs text-yellow-700 mb-2">
                                        Los certificados del SAT a menudo vienen en formato binario (.cer) que requiere conversi√≥n.
                                    </p>
                                    <p class="text-xs text-yellow-700">
                                        <strong>Soluciones:</strong><br>
                                        ‚Ä¢ Usa el archivo .cer que descargaste del SAT<br>
                                        ‚Ä¢ Si el problema persiste, el archivo podr√≠a estar en formato DER<br>
                                        ‚Ä¢ Contacta a soporte t√©cnico si necesitas ayuda con la conversi√≥n
                                    </p>
                                </div>
                            @endif
                            
                            @if ($errors->has('llave_privada') && str_contains($errors->first('llave_privada'), 'binario'))
                                <div class="mt-3 p-3 bg-orange-50 border border-orange-200 rounded-md">
                                    <h4 class="text-sm font-medium text-orange-800 mb-1">üîß Soluci√≥n para Llave Binaria</h4>
                                    <p class="text-xs text-orange-700 mb-2">
                                        Su llave privada est√° en formato binario (DER) del SAT y necesita conversi√≥n.
                                    </p>
                                    <p class="text-xs text-orange-700">
                                        <strong>Opciones:</strong><br>
                                        ‚Ä¢ Descarga nuevamente tu eFirma del SAT solicitando formato PEM<br>
                                        ‚Ä¢ Usa herramientas de conversi√≥n DER a PEM<br>
                                        ‚Ä¢ Contacta a soporte t√©cnico para asistencia
                                    </p>
                                </div>
                            @endif
                        </div>
                    </div>
                </div>
            @endif

            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-8">
                <form method="POST" action="{{ route('edocument.consulta') }}" enctype="multipart/form-data">
                    @csrf
                    <div class="grid grid-cols-1 gap-6">
                        @if(isset($solicitantes) && $solicitantes->count() > 0)
                            <div>
                                <label for="solicitante_id" class="block text-sm font-semibold text-slate-700 mb-2">
                                    Seleccionar Solicitante
                                </label>
                                <select 
                                    name="solicitante_id" 
                                    id="solicitante_id" 
                                    class="form-input w-full"
                                    required
                                >
                                    <option value="">Seleccione un solicitante...</option>
                                    @foreach($solicitantes as $solicitante)
                                        <option value="{{ $solicitante->id }}" 
                                                {{ old('solicitante_id', $solicitante_seleccionado ?? '') == $solicitante->id ? 'selected' : '' }}>
                                            {{ $solicitante->applicant_rfc }} - {{ $solicitante->business_name }}
                                        </option>
                                    @endforeach
                                </select>
                                <p class="text-xs text-slate-500 mt-1">
                                    Seleccione el RFC del solicitante para realizar la consulta en VUCEM
                                </p>
                            </div>

                            <div>
                                <label for="folio_edocument" class="block text-sm font-semibold text-slate-700 mb-2">Folio eDocument</label>
                                <input
                                    type="text"
                                    name="folio_edocument"
                                    id="folio_edocument"
                                    value="{{ old('folio_edocument', $folio ?? '') }}"
                                    class="form-input w-full"
                                    placeholder="Ej. ABC123456789"
                                    required
                                />
                                <p class="text-xs text-slate-500 mt-1">
                                    Ingrese el folio del eDocument a consultar en VUCEM
                                </p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="certificado" class="block text-sm font-semibold text-slate-700 mb-2">
                                        Certificado de eFirma
                                    </label>
                                    <input 
                                        type="file" 
                                        name="certificado" 
                                        id="certificado" 
                                        class="form-input w-full" 
                                        accept=".cer,.crt,.pem,.der,.p7b,.p7c" 
                                        required
                                    >
                                    <p class="text-xs text-slate-500 mt-1">
                                        Formatos: .cer, .crt, .pem, .der, .p7b, .p7c
                                    </p>
                                </div>

                                <div>
                                    <label for="llave_privada" class="block text-sm font-semibold text-slate-700 mb-2">
                                        Llave Privada de eFirma
                                    </label>
                                    <input 
                                        type="file" 
                                        name="llave_privada" 
                                        id="llave_privada" 
                                        class="form-input w-full" 
                                        accept=".key,.pem,.p8,.der" 
                                        required
                                    >
                                    <p class="text-xs text-slate-500 mt-1">
                                        Formatos: .key, .pem, .p8, .der
                                    </p>
                                </div>
                            </div>

                            <div>
                                <label for="contrasena_llave" class="block text-sm font-semibold text-slate-700 mb-2">
                                    Contrase√±a de la Llave Privada
                                </label>
                                <input 
                                    type="password" 
                                    name="contrasena_llave" 
                                    id="contrasena_llave" 
                                    class="form-input w-full" 
                                    placeholder="Contrase√±a de su eFirma del SAT"
                                    required
                                >
                                <p class="text-xs text-slate-500 mt-1">
                                    Contrase√±a que configur√≥ cuando obtuvo su eFirma del SAT
                                </p>
                            </div>

                            <div class="flex justify-end">
                                <button type="submit" class="btn-primary">
                                    <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                                    Consultar eDocument
                                </button>
                            </div>
                        @else
                            <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                                <div class="flex items-start">
                                    <i data-lucide="alert-triangle" class="w-5 h-5 text-amber-500 mt-0.5 mr-3"></i>
                                    <div>
                                        <h4 class="text-sm font-medium text-amber-800 mb-1">No hay solicitantes registrados</h4>
                                        <p class="text-xs text-amber-700 mb-2">
                                            Necesitas registrar al menos un solicitante (RFC) con clave webservice VUCEM para poder consultar eDocuments.
                                        </p>
                                        <a href="{{ route('applicants.create') }}" class="inline-flex items-center text-xs font-medium text-amber-800 hover:text-amber-900">
                                            <i data-lucide="plus-circle" class="w-3 h-3 mr-1"></i>
                                            Registrar Solicitante
                                        </a>
                                    </div>
                                </div>
                            </div>
                        @endif
                    </div>
                </form>
            </div>

            @if(isset($result))
                <div class="mt-8">
                    <!-- Resumen del resultado -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-8">
                        <h3 class="text-2xl font-bold text-[#001a4d] mb-6">Resultado de la consulta</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <p class="text-slate-400 uppercase text-xs font-semibold mb-2">Folio</p>
                                <p class="text-slate-700 font-semibold">{{ $folio }}</p>
                            </div>
                            
                            @if(isset($solicitante_seleccionado) && isset($solicitantes))
                                @php
                                    $solicitante_usado = $solicitantes->find($solicitante_seleccionado);
                                @endphp
                                @if($solicitante_usado)
                                    <div>
                                        <p class="text-slate-400 uppercase text-xs font-semibold mb-2">Solicitante</p>
                                        <p class="text-slate-700 font-semibold">{{ $solicitante_usado->applicant_rfc }}</p>
                                        <p class="text-xs text-slate-500">{{ $solicitante_usado->business_name }}</p>
                                    </div>
                                @endif
                            @endif
                            
                            <div>
                                <p class="text-slate-400 uppercase text-xs font-semibold mb-2">Estatus</p>
                                <p class="text-slate-700 font-semibold">
                                    @if($result['success'])
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            <i data-lucide="check-circle" class="w-3 h-3 mr-1"></i>
                                            Consulta Exitosa
                                        </span>
                                    @else
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            <i data-lucide="x-circle" class="w-3 h-3 mr-1"></i>
                                            Error en Consulta
                                        </span>
                                    @endif
                                </p>
                            </div>
                            
                            <div>
                                <p class="text-slate-400 uppercase text-xs font-semibold mb-2">Mensaje</p>
                                <p class="text-slate-700">{{ $result['message'] ?? 'Sin mensaje' }}</p>
                            </div>
                            
                            <div>
                                <p class="text-slate-400 uppercase text-xs font-semibold mb-2">√öltima consulta</p>
                                <p class="text-slate-700">{{ $record ? optional($record->fecha_ultima_consulta)->format('d/m/Y H:i') : now()->format('d/m/Y H:i') }}</p>
                            </div>
                        </div>

                        @if(isset($result['cove_data']) && !empty($result['cove_data']))
                            <div class="mt-8 pt-8 border-t border-slate-200">
                                <h4 class="text-lg font-bold text-[#001a4d] mb-4">Datos del COVE</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    @foreach($result['cove_data'] as $key => $value)
                                        @if(!empty($value) && !is_array($value) && !is_object($value))
                                            <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                                <p class="text-slate-400 uppercase text-xs font-semibold mb-2">
                                                    {{ ucwords(str_replace('_', ' ', preg_replace('/([A-Z])/', ' $1', $key))) }}
                                                </p>
                                                <p class="text-slate-700 font-medium">
                                                    @if(is_bool($value))
                                                        {{ $value ? 'S√≠' : 'No' }}
                                                    @else
                                                        {{ $value }}
                                                    @endif
                                                </p>
                                            </div>
                                        @endif
                                    @endforeach
                                </div>
                            </div>
                        @endif

                        <div class="mt-8 pt-8 border-t border-slate-200">
                            <h4 class="text-lg font-bold text-[#001a4d] mb-4">Archivos asociados</h4>
                            @if(!empty($files))
                                <ul class="divide-y divide-slate-200">
                                    @foreach($files as $file)
                                        <li class="py-3 flex items-center justify-between">
                                            <div>
                                                <p class="text-slate-700 font-semibold">{{ $file['name'] }}</p>
                                                <p class="text-xs text-slate-400">{{ $file['mime'] }}</p>
                                            </div>
                                            <a href="{{ route('edocument.descargar', $file['token']) }}" class="btn-secondary">
                                                <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                                                Descargar
                                            </a>
                                        </li>
                                    @endforeach
                                </ul>
                            @else
                                <p class="text-slate-500">No se encontraron archivos asociados en la respuesta de VUCEM.</p>
                            @endif
                        </div>
                    </div>
                </div>
            @endif
        </main>
    </div>
</x-app-layout>

                    <!-- Resumen del resultado -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                        <!-- Header del resultado -->
                        <div class="@if($result['success']) bg-gradient-to-r from-green-500 to-emerald-600 @else bg-gradient-to-r from-red-500 to-rose-600 @endif px-6 py-3">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h3 class="text-base font-bold text-white">
                                        @if($result['success'])
                                            Consulta Exitosa
                                        @else
                                            Error en la Consulta
                                        @endif
                                    </h3>
                                    <p class="text-white/90 text-xs mt-0.5">{{ $result['message'] ?? 'Sin mensaje' }}</p>
                                </div>
                                <div class="hidden md:flex items-center justify-center w-10 h-10 bg-white/20 rounded-lg">
                                    <i data-lucide="@if($result['success']) check-circle-2 @else alert-circle @endif" class="w-6 h-6 text-white"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Informaci√≥n del folio -->
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="bg-slate-50 p-3 rounded-lg">
                                    <p class="text-slate-400 uppercase text-xs font-semibold mb-1">Folio eDocument</p>
                                    <p class="text-slate-900 font-bold text-sm">{{ $folio }}</p>
                                </div>
                                
                                @if(isset($solicitante_seleccionado) && isset($solicitantes))
                                    @php
                                        $solicitante_usado = $solicitantes->find($solicitante_seleccionado);
                                    @endphp
                                    @if($solicitante_usado)
                                        <div class="bg-blue-50 p-3 rounded-lg">
                                            <p class="text-blue-400 uppercase text-xs font-semibold mb-1">Solicitante (RFC)</p>
                                            <p class="text-blue-900 font-bold text-sm">{{ $solicitante_usado->applicant_rfc }}</p>
                                            <p class="text-xs text-blue-600 mt-0.5">{{ $solicitante_usado->business_name }}</p>
                                        </div>
                                    @endif
                                @endif
                                
                                <div class="bg-purple-50 p-3 rounded-lg">
                                    <p class="text-purple-400 uppercase text-xs font-semibold mb-1">√öltima Consulta</p>
                                    <p class="text-purple-900 font-bold text-sm">
                                        {{ $record ? optional($record->fecha_ultima_consulta)->format('d/m/Y H:i') : now()->format('d/m/Y H:i') }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    @if(isset($result['cove_data']) && !empty($result['cove_data']))
                        <!-- Tarjeta de datos del COVE -->
                        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-500 to-indigo-600 px-6 py-2.5">
                                <h4 class="text-sm font-semibold text-white flex items-center">
                                    <i data-lucide="file-text" class="w-4 h-4 mr-2"></i>
                                    Informaci√≥n del COVE
                                </h4>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    @foreach($result['cove_data'] as $key => $value)
                                        @if(!empty($value) && !is_array($value) && !is_object($value))
                                            <div class="bg-gradient-to-br from-slate-50 to-blue-50 p-4 rounded-xl border border-slate-200 hover:shadow-md transition-shadow">
                                                <p class="text-slate-500 uppercase text-xs font-bold mb-2 tracking-wider">
                                                    {{ ucwords(str_replace('_', ' ', preg_replace('/([A-Z])/', ' $1', $key))) }}
                                                </p>
                                                <p class="text-slate-900 font-semibold text-sm">
                                                    @if(is_bool($value))
                                                        <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium {{ $value ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800' }}">
                                                            @if($value)
                                                                <i data-lucide="check" class="w-3 h-3 mr-1"></i> S√≠
                                                            @else
                                                                <i data-lucide="x" class="w-3 h-3 mr-1"></i> No
                                                            @endif
                                                        </span>
                                                    @else
                                                        {{ $value }}
                                                    @endif
                                                </p>
                                            </div>
                                        @endif
                                    @endforeach
                                </div>
                            </div>
                        </div>
                    @endif

                    <!-- Tarjeta de archivos adjuntos -->
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 px-6 py-2.5">
                            <h4 class="text-sm font-semibold text-white flex items-center">
                                <i data-lucide="paperclip" class="w-4 h-4 mr-2"></i>
                                Archivos Adjuntos y Acuses
                            </h4>
                        </div>
                        <div class="p-6">
                            @if(!empty($files))
                                <div class="bg-green-50 border border-green-200 rounded-lg p-3 mb-4">
                                    <div class="flex items-center">
                                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center mr-2">
                                            <i data-lucide="check-circle" class="w-4 h-4 text-white"></i>
                                        </div>
                                        <div>
                                            <p class="text-xs font-bold text-green-900">
                                                Se encontraron {{ count($files) }} archivo(s) asociado(s)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="space-y-2">
                                    @foreach($files as $index => $file)
                                        <div class="bg-gradient-to-r from-slate-50 to-purple-50 border border-slate-200 rounded-lg p-3 hover:border-purple-400 transition-all">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center flex-1">
                                                    <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg flex items-center justify-center text-white font-bold text-sm mr-3">
                                                        {{ $index + 1 }}
                                                    </div>
                                                    <div class="flex-1">
                                                        <p class="text-slate-900 font-semibold text-sm">{{ $file['name'] }}</p>
                                                        <div class="flex flex-wrap items-center gap-2 mt-0.5">
                                                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                                {{ $file['mime'] }}
                                                            </span>
                                                            @if(isset($file['size']))
                                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-slate-100 text-slate-800">
                                                                    {{ number_format($file['size'] / 1024, 2) }} KB
                                                                </span>
                                                            @endif
                                                        </div>
                                                    </div>
                                                </div>
                                                <a href="{{ route('edocument.descargar', $file['token']) }}" 
                                                   class="ml-3 inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-600 to-pink-600 text-white text-xs font-bold rounded-lg hover:from-purple-700 hover:to-pink-700 transition-all">
                                                    <i data-lucide="download" class="w-3.5 h-3.5 mr-1.5"></i>
                                                    Descargar
                                                </a>
                                            </div>
                                        </div>
                                    @endforeach
                                </div>
                                
                                <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
                                    <p class="text-xs text-amber-700">
                                        <strong>Nota:</strong> Los archivos estar√°n disponibles durante 60 minutos.
                                    </p>
                                </div>
                            @else
                                <div class="bg-slate-50 border border-dashed border-slate-300 rounded-lg p-8 text-center">
                                    <div class="w-12 h-12 bg-slate-200 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="inbox" class="w-6 h-6 text-slate-400"></i>
                                    </div>
                                    <p class="text-slate-600 font-semibold text-sm mb-1">Sin archivos asociados</p>
                                    <p class="text-slate-500 text-xs">
                                        No se encontraron archivos adjuntos o acuses en la respuesta de VUCEM
                                    </p>
                                </div>
                            @endif
                        </div>
                    </div>
                </div>
            @endif
        </main>
    </div>
</x-app-layout>
